<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Разделитель Excel файлов по столбцу</title>
    <!-- Подключаем Tailwind CSS для стилизации -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Подключаем библиотеку для работы с Excel -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.full.min.js"></script>

    <!-- Подключаем иконки Heroicons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/heroicons/2.1.1/24/outline/heroicons.min.css" rel="stylesheet">
    <style>
        /* Дополнительные стили для плавных переходов и кастомизации */
        body {
            font-family: 'Inter', sans-serif;
        }
        .transition-all {
            transition: all 0.3s ease-in-out;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">

    <div class="w-full max-w-2xl mx-auto bg-white rounded-xl shadow-lg p-8 space-y-6">
        
        <!-- Заголовок -->
        <div class="text-center">
            <h1 class="text-3xl font-bold text-gray-800">Разделитель Excel-файлов</h1>
            <p class="text-gray-500 mt-2">Загрузите файл, укажите столбец для группировки, и получите новый файл с листами по каждому значению.</p>
        </div>

        <!-- Шаг 1: Загрузка файла -->
        <div>
            <label for="file-upload" class="block text-sm font-medium text-gray-700 mb-2">Шаг 1: Выберите Excel-файл</label>
            <label for="file-upload" class="relative cursor-pointer bg-white rounded-md font-medium text-indigo-600 hover:text-indigo-500 focus-within:outline-none focus-within:ring-2 focus-within:ring-offset-2 focus-within:ring-indigo-500">
                <div id="drop-zone" class="flex justify-center items-center w-full px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-md">
                    <div id="upload-prompt" class="space-y-1 text-center">
                        <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true">
                            <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                        </svg>
                        <div class="flex text-sm text-gray-600">
                            <span class="text-indigo-600">Нажмите для загрузки</span>
                            <p class="pl-1">или перетащите файл сюда</p>
                        </div>
                        <p class="text-xs text-gray-500">XLSX, XLS</p>
                    </div>
                     <div id="file-info" class="hidden text-center">
                        <p class="text-lg font-semibold text-green-600">Файл загружен!</p>
                        <p id="file-name" class="text-sm text-gray-700"></p>
                    </div>
                </div>
                <input id="file-upload" name="file-upload" type="file" class="sr-only" accept=".xlsx,.xls,.csv">
            </label>
        </div>

        <!-- Шаг 2: Настройки -->
        <div id="settings" class="hidden space-y-4">
            <div>
                <label for="sheet-select" class="block text-sm font-medium text-gray-700">Шаг 2: Выберите лист для обработки</label>
                <select id="sheet-select" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md"></select>
            </div>
            <div>
                <label for="column-name" class="block text-sm font-medium text-gray-700">Шаг 3: Введите название столбца для группировки</label>
                <input type="text" id="column-name" value="Регион" class="mt-1 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md p-2" placeholder="Например, Регион или Город">
            </div>
        </div>

        <!-- Шаг 3: Кнопка действия -->
        <button id="process-btn" disabled class="w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 disabled:bg-gray-400 disabled:cursor-not-allowed transition-all">
            Разделить и скачать
        </button>

        <!-- Статус -->
        <div id="status" class="text-center text-sm text-gray-600 h-5"></div>

    </div>

    <script>
        // DOM элементы
        const fileInput = document.getElementById('file-upload');
        const dropZone = document.getElementById('drop-zone');
        const uploadPrompt = document.getElementById('upload-prompt');
        const fileInfo = document.getElementById('file-info');
        const fileNameEl = document.getElementById('file-name');
        const settingsDiv = document.getElementById('settings');
        const sheetSelect = document.getElementById('sheet-select');
        const columnNameInput = document.getElementById('column-name');
        const processBtn = document.getElementById('process-btn');
        const statusEl = document.getElementById('status');
        
        // Глобальные переменные для хранения данных
        let workbook;
        let originalFileName = '';

        // Функция для сброса состояния
        const resetState = () => {
            workbook = null;
            originalFileName = '';
            processBtn.disabled = true;
            settingsDiv.classList.add('hidden');
            uploadPrompt.classList.remove('hidden');
            fileInfo.classList.add('hidden');
            statusEl.textContent = '';
            sheetSelect.innerHTML = '';
        };

        // Обработчик выбора файла
        const handleFile = async (file) => {
            if (!file) return;

            resetState();
            originalFileName = file.name;
            statusEl.textContent = 'Чтение файла...';
            processBtn.disabled = true;

            try {
                const data = await file.arrayBuffer();
                workbook = XLSX.read(data, { type: 'array' });

                if (workbook.SheetNames.length === 0) {
                    throw new Error("В файле не найдено листов.");
                }

                // Заполняем селектор листов
                workbook.SheetNames.forEach(name => {
                    const option = document.createElement('option');
                    option.value = name;
                    option.textContent = name;
                    sheetSelect.appendChild(option);
                });
                
                // Показываем информацию о файле и настройки
                fileNameEl.textContent = `«${originalFileName}»`;
                uploadPrompt.classList.add('hidden');
                fileInfo.classList.remove('hidden');
                settingsDiv.classList.remove('hidden');
                processBtn.disabled = false;
                statusEl.textContent = 'Файл готов к обработке.';

            } catch (error) {
                console.error(error);
                statusEl.textContent = `Ошибка: ${error.message}`;
                statusEl.classList.add('text-red-500');
                resetState();
            }
        };
        
        // События для загрузки файла
        fileInput.addEventListener('change', (e) => handleFile(e.target.files[0]));
        
        // События для Drag & Drop
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            e.stopPropagation();
            dropZone.classList.add('border-indigo-500', 'bg-gray-50');
        });

        dropZone.addEventListener('dragleave', (e) => {
            e.preventDefault();
            e.stopPropagation();
            dropZone.classList.remove('border-indigo-500', 'bg-gray-50');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            e.stopPropagation();
            dropZone.classList.remove('border-indigo-500', 'bg-gray-50');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                fileInput.files = files; // Присваиваем файлы инпуту, чтобы сработал 'change'
                handleFile(files[0]);
            }
        });

        // Обработчик нажатия на кнопку "Разделить"
        processBtn.addEventListener('click', () => {
            if (!workbook) return;

            const columnName = columnNameInput.value.trim();
            if (!columnName) {
                statusEl.textContent = 'Ошибка: Введите имя столбца для группировки.';
                statusEl.classList.add('text-red-500');
                return;
            }
            
            statusEl.textContent = 'Идет обработка...';
            statusEl.classList.remove('text-red-500');
            processBtn.disabled = true;
            processBtn.textContent = 'Обработка...';

            // Используем setTimeout чтобы дать UI обновиться перед тяжелой операцией
            setTimeout(() => {
                try {
                    const selectedSheetName = sheetSelect.value;
                    const sheet = workbook.Sheets[selectedSheetName];
                    const json = XLSX.utils.sheet_to_json(sheet);

                    if (json.length === 0) {
                        throw new Error("Выбранный лист пуст.");
                    }

                    if (!json[0].hasOwnProperty(columnName)) {
                        const availableColumns = Object.keys(json[0]).join(', ');
                        throw new Error(`Столбец "${columnName}" не найден. Доступные столбцы: ${availableColumns}`);
                    }

                    const groups = {};
                    json.forEach(row => {
                        const groupValue = row[columnName] || 'Без_значения';
                        const cleanGroupValue = String(groupValue).replace(/[\\/?*[\]]/g, '').slice(0, 31);
                        (groups[cleanGroupValue] ||= []).push(row);
                    });

                    const outputWorkbook = XLSX.utils.book_new();
                    Object.entries(groups).forEach(([groupName, rows]) => {
                        const worksheet = XLSX.utils.json_to_sheet(rows);

                        // --- НАЧАЛО БЛОКА ФОРМАТИРОВАНИЯ ---

                        // 0. Быстрая вспомогательная функция: см → px (96 dpi)
                        const cm2px = cm => Math.round(cm * 37.79527559);   // 1 см ≈ 37.8 px

                        const range = XLSX.utils.decode_range(worksheet['!ref']);

                        // 1. Фикс-ширина 3.75 см (≈ 142 px) для каждой колонки
                        const colWidths = [];
                        const fixedWidthPx = cm2px(3.75);                   // = 142 px
                        for (let C = range.s.c; C <= range.e.c; ++C) {
                        colWidths.push({ wpx: fixedWidthPx });
                        }
                        worksheet['!cols'] = colWidths;

                        // 2. Единый стиль ячейки: перенос + выравнивание по центру
                        const cellStyle = {
                        alignment: {
                            horizontal: "center",
                            vertical:   "center",
                            wrapText:   true
                        }
                        };

                        // Применяем стиль ко всем ячейкам диапазона
                        for (let R = range.s.r; R <= range.e.r; ++R) {
                        for (let C = range.s.c; C <= range.e.c; ++C) {
                            const addr = XLSX.utils.encode_cell({ c: C, r: R });
                            if (!worksheet[addr]) continue;      // пустая ячейка
                            worksheet[addr].s = cellStyle;
                        }
                        }

                        // 3. Высоту строк не задаём намеренно — при wrapText: true
                        //    Excel сам увеличит её «под контент» при открытии файла.

                        // --- КОНЕЦ БЛОКА ФОРМАТИРОВАНИЯ ---


                        XLSX.utils.book_append_sheet(outputWorkbook, worksheet, groupName);
                    });

                    const outputFileName = `${originalFileName.replace(/\.(xlsx|xls|csv)$/, '')}_by_${columnName}.xlsx`;
                    XLSX.writeFile(outputWorkbook, outputFileName);

                    statusEl.textContent = `Готово! Файл «${outputFileName}» сохранён.`;
                } catch (error) {
                    console.error(error);
                    statusEl.textContent = `Ошибка: ${error.message}`;
                    statusEl.classList.add('text-red-500');
                } finally {
                    processBtn.disabled = false;
                    processBtn.textContent = 'Разделить и скачать';
                }
            }, 50);
        });

    </script>
</body>
</html>
